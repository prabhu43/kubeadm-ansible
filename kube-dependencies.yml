- hosts: all
  become: yes
  tasks:
   - name: Disable swap
     command: "{{ item }}"
     with_items:
       - "swapoff -a"
       - "sed -i '/ swap /s/^/#/' /etc/fstab"

  #  - name: install policycoreutils
  #    apt:
  #      name: policycoreutils
  #      update_cache: yes

   - name: Check if bridge-nf-call-iptables key exists
     command: "sysctl net.bridge.bridge-nf-call-iptables"
     failed_when: false
     register: sysctl_bridge_nf_call_iptables

   - name: Enable bridge-nf-call tables
     sysctl:
       name: "{{ item }}"
       state: present
       value: 1
       reload: yes
     when: sysctl_bridge_nf_call_iptables.rc == 0
     with_items:
       - net.bridge.bridge-nf-call-iptables
       - net.bridge.bridge-nf-call-arptables
       - net.bridge.bridge-nf-call-ip6tables
  
   - name: install Docker
     apt:
       name: docker.io
       state: present
       update_cache: true

   - name: install APT Transport HTTPS
     apt:
       name: apt-transport-https
       state: present
  
   - name: add Kubernetes apt-key
     apt_key:
       url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
       state: present
  
   - name: add Kubernetes' APT repository
     apt_repository:
       repo: deb http://apt.kubernetes.io/ kubernetes-xenial main
       state: present
       filename: 'kubernetes'
  
   - name: install kubelet
     apt:
       name: kubelet=1.14.0-00
       state: present
       update_cache: true
  
   - name: install kubeadm
     apt:
       name: kubeadm=1.14.0-00
       state: present

- hosts: kube-master
  become: yes
  tasks:
   - name: install kubectl
     apt:
       name: kubectl=1.14.0-00
       state: present
       force: yes